# Seal Access Policies 使用指南

## 概述

Seal Access Policies 允许您控制谁可以访问您的加密情绪记录。启用后，您可以：
- **分享记录**：授权特定地址访问您的私有记录
- **管理权限**：查看、添加、撤销授权
- **链上验证**：所有权限操作都记录在 Sui 区块链上，可公开验证和审计

## 使用流程

### 1. 启用 Seal Access Policies

在记录情绪时：
1. 确保已连接钱包
2. 启用"鑄造為 NFT"选项
3. 启用"啟用 Seal Access Policies"选项
4. 完成记录并铸造 NFT

### 2. 分享记录（授权访问）

#### 📍 位置一：记录页面（记录完成后立即分享）

**路径**：`/record` 页面 → 记录完成后

**步骤**：
1. 完成情绪记录并成功铸造 NFT 后
2. 在右侧栏的"儲存設定"区域下方，会显示**"分享記錄"**按钮
3. 点击"分享記錄"按钮
4. 在弹出的对话框中：
   - 选择要分享的对象（心理師、伴侶、家人、醫生、朋友、或自定义地址）
   - 输入对方的钱包地址（66 字符，以 `0x` 开头）
   - 点击"分享"按钮
5. 确认钱包交易

**适用场景**：记录完成后立即分享给他人

#### 📍 位置二：时间轴页面（随时管理权限）

**路径**：`/timeline` 页面 → 点击记录 → 详情对话框

**步骤**：
1. 进入"時間軸"页面（点击首页的"查看時間軸"或导航到 `/timeline`）
2. 找到要分享的记录（必须是已铸造为 NFT 的记录）
3. 点击该记录卡片，打开详情对话框
4. 在详情对话框底部，找到**"訪問權限管理"**部分
5. 点击**"授權訪問"**按钮
6. 在弹出的对话框中：
   - 选择角色（可选）：伴侶、家人、心理師、醫生、AI Agent、朋友、其他
   - 输入钱包地址
   - 点击"授權"按钮
7. 确认钱包交易

**适用场景**：随时管理已记录的情绪的访问权限

### 3. 管理授权（在时间轴页面）

**路径**：`/timeline` 页面 → 点击记录 → 详情对话框 → "訪問權限管理"部分

在时间线的记录详情中，您可以：

#### 查看授权列表
- 查看所有已授权访问的地址
- 查看每个地址的角色标签（如：伴侶、心理師等）
- 查看授权时间

#### 授权新地址
1. 在"訪問權限管理"部分，点击**"授權訪問"**按钮
2. 选择角色（可选）：
   - 伴侶
   - 家人
   - 心理師
   - 醫生
   - AI Agent
   - 朋友
   - 其他
3. 输入钱包地址（66 字符，以 0x 开头）
4. 点击"授權"按钮
5. 确认钱包交易

#### 撤销授权
1. 在授权列表中找到要撤销的地址
2. 点击该地址旁边的"撤销"按钮（UserMinus 图标）
3. 确认钱包交易

**注意**：撤销授权后，该地址将无法再访问该记录。

#### 查看授权历史
1. 在"訪問權限管理"部分，点击**"歷史"**按钮
2. 查看所有授权/撤销操作的历史记录
3. 包括操作时间、地址和交易哈希

### 4. 访问被分享的记录

当有人授权您访问记录时：
1. 确保您使用被授权的钱包地址连接
2. 在时间线中，您应该能看到该记录
3. 点击记录查看详情
4. 系统会自动使用您的钱包密钥解密内容

## 功能特点

### ✅ 链上验证
- 所有授权操作都记录在 Sui 区块链上
- 任何人都可以验证某个地址是否有访问权限
- 完整的操作历史可审计

### ✅ 角色管理
- 为每个授权地址设置角色标签
- 方便识别和管理不同的授权对象
- 角色信息保存在本地，便于管理

### ✅ 灵活控制
- 随时可以授权新地址
- 随时可以撤销授权
- 支持多个地址同时访问

### ✅ 隐私保护
- 只有被授权的地址才能解密记录
- 授权操作本身是公开的，但记录内容仍然是加密的
- 记录所有者始终可以访问自己的记录

## 注意事项

1. **PolicyRegistry 必须存在**
   - 如果看到"PolicyRegistry 未找到"警告，需要先部署 Seal Access Policies 合约
   - 部署后，PolicyRegistry ID 会自动配置

2. **需要钱包连接**
   - 所有授权/撤销操作都需要钱包签名
   - 确保钱包有足够的 SUI 代币支付 Gas 费用

3. **地址格式**
   - Sui 钱包地址必须是 66 字符
   - 必须以 `0x` 开头

4. **网络匹配**
   - 确保授权者和被授权者使用相同的网络（testnet/mainnet）
   - 不同网络的授权不会生效

## 快速导航

### 分享记录的位置

1. **记录完成后立即分享**：
   - 页面：`/record`（记录页面）
   - 位置：记录完成后，右侧栏下方
   - 按钮：**"分享記錄"**

2. **随时管理权限**：
   - 页面：`/timeline`（时间轴页面）
   - 位置：点击记录 → 详情对话框 → 底部
   - 部分：**"訪問權限管理"**
   - 按钮：**"授權訪問"**（添加新授权）

## 常见问题

### Q: 如何知道谁可以访问我的记录？
A: 进入时间轴页面（`/timeline`），点击记录打开详情，在"訪問權限管理"部分可以看到所有已授权的地址列表。

### Q: 记录完成后没有看到"分享記錄"按钮？
A: 确保：
1. 已启用"鑄造為 NFT"选项
2. 已启用"啟用 Seal Access Policies"选项
3. NFT 已成功铸造（`lastMintedNftId` 存在）

### Q: 撤销授权后，对方还能看到记录吗？
A: 不能。撤销授权后，该地址将无法再解密和访问该记录。

### Q: 可以授权多个地址吗？
A: 可以。您可以授权任意数量的地址访问同一个记录。

### Q: 授权操作需要费用吗？
A: 是的，每次授权/撤销操作都需要支付 Sui 网络的 Gas 费用。

### Q: 授权记录在哪里查看？
A: 所有授权操作都记录在 Sui 区块链上，可以通过 Sui Explorer 查看交易详情。

## 技术细节

- **合约模块**：`seal_access_policies`
- **PolicyRegistry**：共享对象，存储所有访问策略
- **访问策略**：每个 EntryNFT 对应一个访问策略
- **授权事件**：`AccessGrantedEvent` 和 `AccessRevokedEvent`

