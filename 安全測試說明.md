# 安全測試套件說明

本安全測試套件涵蓋了以下五個關鍵安全測試場景：

## 1. 密碼學向量測試（AES-GCM）

測試 AES-GCM 加密的安全屬性，確保以下攻擊必須失敗：

### 測試項目：
- **Tag 篡改測試**：修改認證標籤後，解密必須失敗
- **IV 重用測試**：重用初始化向量時，必須檢測到安全漏洞
- **截斷密文測試**：截斷密文（包括 tag）後，解密必須失敗

### 預期結果：
所有篡改嘗試都應該導致解密失敗，並返回適當的錯誤類型（`DATA_CORRUPTED` 或 `INVALID_KEY`）。

## 2. 參數回放測試

測試同一數據在不同設備配置下的加密和解密兼容性。

### 測試場景：
- **低端手機**：100,000 次 PBKDF2 迭代
- **中端手機**：300,000 次 PBKDF2 迭代
- **高端手機**：500,000 次 PBKDF2 迭代
- **桌機**：1,000,000 次 PBKDF2 迭代

### 測試內容：
1. 在不同設備上加密相同數據
2. 驗證加密參數（迭代數）正確保存
3. 跨設備解密：在設備 A 加密，在設備 B 解密

### 預期結果：
- 所有設備都能成功加密和解密
- 跨設備解密應該成功（使用相同的密碼和參數）

## 3. Base64/UTF-8 邊界測試

測試各種 Unicode 邊界情況，確保序列化/反序列化不破壞數據完整性。

### 測試用例：
- **Emoji**：大量 emoji 字符
- **合字（Ligatures）**：如 ﬁ, ﬂ, ﬀ 等
- **長文**：10KB 文本
- **混合 Unicode**：多種語言和字符集混合
- **零寬字符**：隱藏的控制字符
- **代理對（Surrogate Pairs）**：需要兩個 16 位單元表示的字符
- **組合字符**：帶聲調的字符

### 驗證方法：
1. 加密原始文本
2. JSON 序列化和反序列化
3. 解密並驗證：
   - 字節長度完全匹配
   - 逐字節比較完全一致
   - 字符串內容完全相等

### 預期結果：
所有測試用例都應該通過，確保數據在加密/解密和序列化過程中完全無損。

## 4. Rate Limit 測試

模擬高並發請求，測試限流機制的有效性和恢復能力。

### 測試配置：
- **並發數**：100 個請求
- **發送方式**：在 1 秒內分 10 批發送（每批間隔 100ms）
- **目標端點**：AI 情緒響應端點（`/functions/v1/ai-emotion-response`）

### 測試內容：
1. 發送 100 個並發請求
2. 統計：
   - 成功請求數
   - 被限流請求數（429 狀態碼）
   - 認證錯誤數（401 狀態碼）
   - 其他錯誤數
3. 等待 2 秒後測試恢復能力

### 預期結果：
- 應該有部分請求被限流（返回 429）
- 或者至少部分請求成功
- 限流後應該能夠恢復（後續請求可以成功）

## 5. Key Rotation 演練

測試 API 密鑰輪換期間的平滑過渡，確保不會出現「斷崖式」成功率下降。

### 測試場景：
- **舊密鑰**：當前使用的 API 密鑰
- **新密鑰**：即將切換的新 API 密鑰
- **過渡時長**：5 秒（可配置）

### 測試方法：
1. 在過渡期間，逐漸從舊密鑰切換到新密鑰
2. 每 100ms 測試一次請求
3. 記錄每個時間點的成功率
4. 分析成功率變化曲線

### 驗證標準：
- **不應有斷崖**：成功率不應從 100% 直接降到 0%
- **應平滑過渡**：成功率應該逐漸變化
- **最小成功率**：過渡期間最小成功率應 > 0%

### 預期結果：
- `hasCliff = false`：沒有檢測到斷崖式下降
- `isSmooth = true`：過渡平滑
- `minSuccessRate > 0%`：最小成功率大於 0%

## 使用方法

### 1. 訪問測試頁面

在瀏覽器中訪問：`/security-tests`

### 2. 登錄（可選，但建議）

**重要**：要運行完整的測試套件（包括 Rate Limit 和 Key Rotation 測試），需要先登錄 Supabase：

1. 訪問 `/auth` 頁面
2. 使用現有帳號登錄，或註冊新帳號
3. 登錄成功後，返回 `/security-tests` 頁面

**注意**：
- 前三個測試（密碼學向量、參數回放、UTF-8 邊界）**不需要登錄**即可運行
- 後兩個測試（Rate Limit、Key Rotation）**需要登錄**才能運行
- 如果未登錄，後兩個測試會返回 401 認證錯誤，這是預期的行為

### 3. 運行測試

點擊「運行所有測試」按鈕，系統將依次執行所有測試套件。

### 4. 查看結果

測試完成後，頁面會顯示：
- **測試匯總**：總體統計信息
- **各測試套件結果**：每個測試的詳細結果
- **通過/失敗狀態**：每個測試項的通過情況
- **詳細錯誤信息**：失敗測試的錯誤詳情

## 注意事項

1. **Rate Limit 測試**需要有效的 Supabase 認證會話。如果未登錄，該測試會返回 401 認證錯誤（這是預期的行為）。

2. **Key Rotation 測試**需要配置實際的 API 密鑰輪換場景。當前實現為示例代碼，需要根據實際環境調整。同樣需要登錄才能運行。

3. 某些測試（如 Rate Limit）可能會對服務器造成負載，建議在測試環境運行。

4. 測試結果會顯示在頁面上，可以複製 JSON 格式的詳細信息用於進一步分析。

5. **核心安全測試**（密碼學向量、參數回放、UTF-8 邊界）不需要登錄即可運行，這些測試驗證了加密系統的核心安全屬性。

## 技術實現

- **加密庫**：使用 Web Crypto API 實現 AES-GCM
- **測試框架**：自定義測試框架，支持異步測試和結果聚合
- **UI 組件**：使用 shadcn/ui 組件庫構建測試界面

## 文件結構

```
src/
├── lib/
│   └── securityTests.ts      # 測試實現
└── pages/
    └── SecurityTests.tsx     # 測試 UI 頁面
```

## 擴展測試

如需添加新的測試場景，可以在 `securityTests.ts` 中添加新的測試函數，並在 `runAllSecurityTests` 中調用。
