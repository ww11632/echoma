# 威脅模型與安全設計取捨

## 概述

本文檔說明 Echoma 的威脅模型、安全目標，以及技術選型的設計取捨理由。Echoma 採用**客戶端加密 + 去中心化存儲 + 區塊鏈可驗證性**的架構，以在保護隱私的同時提供不可篡改的證明。

---

## 威脅來源分析

### 1. 使用者本人
- **威脅**：誤操作刪除、設備丟失、密鑰遺忘
- **緩解措施**：
  - 確定性密鑰派生（基於錢包地址或用戶 ID），允許跨設備恢復
  - Walrus 去中心化存儲，數據不依賴單一設備
  - NFT 鏈上證明，即使本地數據丟失也可驗證記錄存在性

### 2. 攻擊者（外部威脅）
- **威脅**：中間人攻擊、服務器數據庫洩漏、網絡監聽、暴力破解
- **緩解措施**：
  - **客戶端加密**：數據在離開設備前已加密（AES-GCM 256位），服務器無法看到明文
  - **強密鑰派生**：PBKDF2（100k-1M 迭代）或 Argon2id，防止暴力破解
  - **AES-GCM 認證標籤**：自動檢測數據篡改
  - **去中心化存儲**：Walrus 分散式架構，降低單點攻擊風險

### 3. 雲端平台（Supabase/服務提供商）
- **威脅**：服務器端數據洩漏、後台管理員訪問、合規要求下的數據交出
- **緩解措施**：
  - **零知識架構**：服務器只存儲加密後的數據，無法解密
  - **可選去中心化存儲**：用戶可選擇 Walrus 而非 Supabase，完全脫離中心化服務
  - **匿名模式**：無需註冊即可使用，減少身份關聯

### 4. 政府/監管機構
- **威脅**：法律要求交出數據、監控、審查
- **緩解措施**：
  - **客戶端加密**：即使被要求交出數據，也無法解密（除非獲得密鑰）
  - **去中心化存儲**：Walrus 基於 Sui 區塊鏈，無單一實體可控制
  - **區塊鏈不可篡改**：NFT 證明記錄的存在性和時間戳，防止事後修改

### 5. 廠商/開發團隊
- **威脅**：後門、惡意更新、數據濫用
- **緩解措施**：
  - **開源代碼**：加密邏輯可審計
  - **客戶端加密**：開發團隊無法訪問明文數據
  - **去中心化存儲**：數據存儲在 Walrus，不依賴開發團隊的服務器

### 6. 未來 AI（量子計算/進階攻擊）
- **威脅**：量子計算破解現有加密、AI 輔助的密碼分析
- **緩解措施**：
  - **AES-256**：目前對量子攻擊有較強抗性（Grover 算法需 2^128 次操作）
  - **版本化加密頭**：支持未來升級到後量子加密算法（如 CRYSTALS-Kyber）
  - **區塊鏈時間戳**：即使加密被破解，區塊鏈證明仍可驗證記錄的原始時間

---

## 安全模型目標

### 核心目標：**保密性 + 可驗證性**

1. **保密性（Confidentiality）**
   - 數據在離開用戶設備前已加密
   - 服務器、存儲提供商、網絡監聽者無法看到明文
   - 只有擁有正確密鑰的用戶可以解密

2. **可驗證性（Verifiability）**
   - 區塊鏈 NFT 證明記錄的存在性和時間戳
   - 不可篡改的鏈上證明，防止事後修改
   - 可公開驗證（無需信任第三方）

3. **完整性（Integrity）**
   - AES-GCM 認證標籤自動檢測數據篡改
   - 區塊鏈哈希確保存儲數據未被修改

4. **可用性（Availability）**
   - 去中心化存儲（Walrus）降低單點故障風險
   - 多種使用模式（匿名/認證/本地）提供備選方案

---

## 設計取捨理由

### 為什麼選擇 **AES-GCM + Walrus + NFT**？

#### ✅ 我們的方案：AES-GCM + Walrus + Sui NFT

**架構流程：**
```
用戶輸入 → 客戶端 AES-GCM 加密 → Walrus 去中心化存儲 → Sui NFT 鏈上證明
```

**優勢：**
1. **保密性**：客戶端加密確保服務器無法看到明文
2. **可驗證性**：NFT 提供不可篡改的鏈上證明
3. **去中心化**：不依賴單一服務提供商
4. **成本效益**：Walrus 存儲成本低，NFT minting 費用可控
5. **性能**：AES-GCM 加密速度快，適合實時應用

---

### ❌ 為什麼不選擇其他方案？

#### 1. Simple DB（傳統數據庫）

**方案描述：** 將數據直接存儲在中心化數據庫（如 PostgreSQL、MongoDB）

**不選擇的理由：**
- ❌ **單點故障**：數據庫服務器故障會導致數據丟失
- ❌ **隱私風險**：即使使用服務器端加密，管理員仍可訪問數據
- ❌ **合規風險**：政府/監管機構可要求交出數據
- ❌ **缺乏可驗證性**：無法證明記錄未被篡改
- ❌ **廠商鎖定**：依賴特定服務提供商

**我們的方案優勢：**
- ✅ 客戶端加密確保服務器無法看到明文
- ✅ 去中心化存儲降低單點故障風險
- ✅ 區塊鏈 NFT 提供不可篡改的證明

---

#### 2. IPFS（星際文件系統）

**方案描述：** 使用 IPFS 存儲加密數據，使用 IPNS 或智能合約進行索引

**不選擇的理由：**
- ❌ **持久性問題**：IPFS 依賴節點自願存儲，數據可能丟失（除非使用 Pin 服務，但這又回到中心化）
- ❌ **性能問題**：IPFS 檢索速度慢，不適合實時應用
- ❌ **成本問題**：長期 Pin 服務（如 Pinata、Infura）需要付費，成本隨數據量增長
- ❌ **可驗證性不足**：IPFS 本身不提供時間戳證明，需要額外的區塊鏈層

**我們的方案優勢：**
- ✅ Walrus 基於 Sui 區塊鏈，數據持久性由區塊鏈保證
- ✅ Walrus 檢索速度快，適合實時應用
- ✅ 成本可控（按 epochs 付費，可預測）
- ✅ NFT 直接提供時間戳和存在性證明

---

#### 3. zk-Proofs（零知識證明）

**方案描述：** 使用 zk-SNARKs/zk-STARKs 證明數據存在性，而不暴露數據內容

**不選擇的理由：**
- ❌ **複雜度高**：zk-Proofs 生成和驗證複雜，需要專業知識
- ❌ **性能開銷**：生成證明需要大量計算資源，不適合實時應用
- ❌ **成本高**：zk-Proofs 的 gas 費用高（特別是在 EVM 鏈上）
- ❌ **過度設計**：對於情緒日記應用，不需要零知識證明級別的可驗證性
- ❌ **用戶體驗差**：證明生成時間長，影響用戶體驗

**我們的方案優勢：**
- ✅ 簡單直接：AES-GCM 加密 + NFT 證明，易於理解和審計
- ✅ 性能好：加密和 minting 速度快，適合實時應用
- ✅ 成本低：Sui 鏈 gas 費用低，NFT minting 成本可控
- ✅ 用戶體驗好：響應速度快

**未來考慮：** 如果未來需要更強的可驗證性（如證明「我記錄了某個情緒但不想暴露內容」），可以考慮在 NFT 中嵌入 zk-Proof，但這不是當前優先級。

---

#### 4. EVM Chain（以太坊/EVM 兼容鏈）

**方案描述：** 在以太坊、Polygon、Arbitrum 等 EVM 鏈上存儲數據或 mint NFT

**不選擇的理由：**
- ❌ **Gas 費用高**：EVM 鏈的 gas 費用高，特別是存儲數據（每 32 字節約 20,000 gas）
- ❌ **性能慢**：EVM 鏈的 TPS 低，交易確認時間長（12-15 秒）
- ❌ **可擴展性差**：EVM 鏈的存儲成本隨數據量線性增長，不適合存儲大量加密數據
- ❌ **用戶體驗差**：高 gas 費用和慢確認時間影響用戶體驗

**我們的方案優勢：**
- ✅ **Sui 鏈性能優異**：高 TPS（數千 TPS），低延遲（亞秒級確認）
- ✅ **成本低**：Sui 鏈的 gas 費用低（通常 < $0.01），適合頻繁操作
- ✅ **存儲分離**：數據存儲在 Walrus（去中心化 blob 存儲），NFT 只存儲元數據和證明，成本可控
- ✅ **用戶體驗好**：快速確認，低費用，適合日常使用

**技術對比：**

| 特性 | EVM Chain | Sui Chain |
|------|-----------|-----------|
| TPS | ~15-100 | 數千+ |
| 確認時間 | 12-15 秒 | <1 秒 |
| Gas 費用 | 高（$1-50+） | 低（<$0.01） |
| 存儲成本 | 高（每 32 字節約 20k gas） | 低（Walrus 按 epochs 付費） |
| 可擴展性 | 差（鏈上存儲成本高） | 好（鏈下存儲 + 鏈上證明） |

---

## 技術選型總結

### 加密層：AES-GCM 256位
- **理由**：業界標準，性能好，提供加密和認證
- **替代方案考慮**：ChaCha20-Poly1305（類似性能，但 AES-GCM 更廣泛支持）

### 密鑰派生：PBKDF2（計劃升級到 Argon2id）
- **理由**：PBKDF2 廣泛支持，Argon2id 提供更強的抗暴力破解能力
- **參數**：100k-1M 迭代（自適應設備性能）

### 存儲層：Walrus
- **理由**：去中心化、成本可控、性能好、與 Sui 鏈原生集成
- **替代方案考慮**：IPFS（持久性問題）、Arweave（成本高）

### 可驗證性層：Sui NFT
- **理由**：高性能、低成本、不可篡改、原生時間戳
- **替代方案考慮**：EVM NFT（成本高、性能慢）、IPFS + 智能合約（複雜度高）

---

## 安全保證

### 可驗證的安全屬性

1. **加密強度**：AES-256-GCM 符合 NIST 標準，對抗當前計算能力安全
2. **密鑰派生**：PBKDF2 100k-1M 迭代，符合 OWASP 建議
3. **數據完整性**：AES-GCM 認證標籤 + 區塊鏈哈希，雙重保護
4. **不可篡改性**：區塊鏈 NFT 提供不可否認的存在性證明
5. **零知識架構**：服務器無法解密用戶數據（除非獲得密鑰）

### 審計要點

- ✅ 加密算法和參數符合業界標準（NIST、OWASP）
- ✅ 客戶端加密確保服務器零知識
- ✅ 去中心化存儲降低單點故障風險
- ✅ 區塊鏈證明提供可驗證的時間戳和存在性
- ✅ 版本化加密頭支持未來算法升級

---

## 未來改進方向

1. **後量子加密**：當量子計算威脅成為現實時，升級到後量子加密算法
2. **Argon2id 完整集成**：解決 WASM 構建問題後，完整集成 Argon2id
3. **多鏈支持**：考慮支持其他高性能鏈（如 Aptos），但 Sui 目前是最佳選擇
4. **可選 zk-Proofs**：為需要更強可驗證性的用戶提供可選的 zk-Proof 功能

---

## 參考資料

- **NIST SP 800-63B**：數字身份指南
- **OWASP Cryptographic Storage Cheat Sheet**：加密存儲最佳實務
- **Sui Documentation**：https://docs.sui.io/
- **Walrus Documentation**：https://docs.walrus.space/
- **AES-GCM Specification**：NIST SP 800-38D

---

**結論**：Echoma 的威脅模型涵蓋了從個人誤操作到未來 AI 攻擊的廣泛威脅場景。我們選擇 **AES-GCM + Walrus + Sui NFT** 的架構，在保密性、可驗證性、性能和成本之間取得了最佳平衡。這個設計是可驗證的、可審計的，並且符合業界安全標準。

